{% extends "base.html" %}

{% block title %}Jobs{% endblock %}

{% block extra_css %}
<style>
    /* Stage 2 Thumbnail Preview Styles */
    .thumbnail-preview-section {
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    .thumbnail-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }

    .thumbnail-item {
        position: relative;
        border-radius: 0.375rem;
        overflow: hidden;
        border: 1px solid #334155;
        background: #1e293b;
    }

    .thumbnail-item img {
        width: 100%;
        height: auto;
        display: block;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .thumbnail-item img:hover {
        transform: scale(1.05);
    }

    .thumbnail-timestamp {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.75);
        color: #e2e8f0;
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        text-align: center;
    }

    .no-thumbnails {
        color: #64748b;
        font-style: italic;
        text-align: center;
        padding: 1rem;
    }

    /* Fullsize thumbnail modal */
    .thumbnail-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }

    .thumbnail-modal.active {
        display: flex;
    }

    .thumbnail-modal img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Jobs</h1>
    <div class="d-flex gap-2">
        <select id="status-filter" class="form-select form-select-sm" style="width: auto;">
            <option value="">All Statuses</option>
            <option value="running">Running</option>
            <option value="assigned">Assigned</option>
            <option value="pending">Pending</option>
            <option value="queued">Queued</option>
            <option value="completed">Completed</option>
            <option value="failed">Failed</option>
            <option value="cancelled">Cancelled</option>
        </select>
        <button class="btn btn-sm btn-outline-primary" onclick="refreshJobs()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
</div>

<!-- Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-4 col-lg-2">
        <div class="stat-card stat-primary">
            <div class="stat-value" id="stat-running">-</div>
            <div class="stat-label">Running</div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="stat-card stat-warning">
            <div class="stat-value" id="stat-pending">-</div>
            <div class="stat-label">Pending</div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="stat-card stat-success">
            <div class="stat-value" id="stat-completed">-</div>
            <div class="stat-label">Completed</div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="stat-card stat-danger">
            <div class="stat-value" id="stat-failed">-</div>
            <div class="stat-label">Failed</div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="stat-card stat-info">
            <div class="stat-value" id="stat-total">-</div>
            <div class="stat-label">Total</div>
        </div>
    </div>
</div>

<!-- Awaiting Approval Section -->
<div class="card mb-4" id="approval-section" style="display: none;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-hourglass-split me-2"></i>Awaiting Approval
            <span class="badge bg-warning ms-2" id="approval-count">0</span>
        </h5>
    </div>
    <div class="card-body" id="approval-jobs-container">
        <!-- Jobs awaiting approval rendered here -->
    </div>
</div>

<!-- Upload Errors Section -->
<div class="card mb-4" id="upload-errors-section" style="display: none;">
    <div class="card-header d-flex justify-content-between align-items-center bg-danger bg-opacity-25">
        <h5 class="mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>Upload Errors
            <span class="badge bg-danger ms-2" id="upload-errors-count">0</span>
        </h5>
    </div>
    <div class="card-body" id="upload-errors-container">
        <!-- Jobs with upload errors rendered here -->
    </div>
</div>

<!-- Active Jobs Section -->
<div class="card mb-4" id="active-section">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-lightning-charge me-2"></i>Active Jobs</h5>
    </div>
    <div class="card-body" id="active-jobs-container">
        <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>No active jobs</p>
        </div>
    </div>
</div>

<!-- Jobs Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-task me-2"></i>All Jobs</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Name</th>
                        <th>Progress</th>
                        <th>Worker</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="jobs-tbody">
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Job Detail Modal -->
<div class="modal fade" id="jobDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Job Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="job-detail-body">
                Loading...
            </div>
        </div>
    </div>
</div>

<!-- Transcode Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-play-circle me-2"></i>Configure Transcode</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="approval-modal-body">
                Loading...
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="approve-btn" onclick="submitApproval()">
                    <i class="bi bi-play-fill me-1"></i>Start Transcoding
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allJobs = [];
    let refreshInterval = null;
    let pendingApprovalJobs = [];
    let uploadErrorJobs = [];
    let availableWorkers = [];
    let availablePresets = [];
    let currentApprovalJobId = null;

    function getStatusClass(status) {
        const classes = {
            running: 'success',
            assigned: 'warning',
            pending: 'primary',
            queued: 'primary',
            completed: 'info',
            failed: 'danger',
            cancelled: 'secondary'
        };
        return classes[status] || 'secondary';
    }

    function renderActiveJobs(jobs) {
        const container = document.getElementById('active-jobs-container');
        const section = document.getElementById('active-section');
        const active = jobs.filter(j => ['running', 'assigned'].includes(j.status));

        if (active.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        container.innerHTML = `<div class="row g-3">${active.map(job => `
            <div class="col-md-6 col-xl-4">
                <div class="job-card">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="badge-status status-${job.status}">${job.status}</span>
                            <span class="badge bg-secondary ms-1">${job.job_type}</span>
                        </div>
                        <button class="btn btn-sm btn-outline-light" onclick="showJobDetail('${job.job_id}')">
                            <i class="bi bi-info-circle"></i>
                        </button>
                    </div>
                    <div class="fw-medium mb-2 text-truncate" title="${job.output_name || job.input_file || 'Unknown'}">
                        ${job.output_name || job.input_file || 'Unknown'}
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-${getStatusClass(job.status)}"
                             style="width: ${job.progress}%"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">
                            ${job.assigned_agent_id ? job.assigned_agent_id.substring(0, 12) : 'Unassigned'}
                        </small>
                        <small class="fw-medium">${job.progress.toFixed(1)}%</small>
                    </div>
                </div>
            </div>
        `).join('')}</div>`;
    }

    function renderJobsTable(jobs) {
        const tbody = document.getElementById('jobs-tbody');
        const filter = document.getElementById('status-filter').value;

        let filtered = jobs;
        if (filter) {
            filtered = jobs.filter(j => j.status === filter);
        }

        // Sort: active first, then by created_at descending
        filtered.sort((a, b) => {
            const activeStatuses = ['running', 'assigned', 'pending', 'queued'];
            const aActive = activeStatuses.includes(a.status);
            const bActive = activeStatuses.includes(b.status);
            if (aActive && !bActive) return -1;
            if (!aActive && bActive) return 1;
            return new Date(b.created_at) - new Date(a.created_at);
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No jobs found</td></tr>';
            return;
        }

        tbody.innerHTML = filtered.map(job => `
            <tr>
                <td><code>${job.job_id.substring(0, 8)}</code></td>
                <td><span class="badge bg-secondary">${job.job_type}</span></td>
                <td><span class="badge-status status-${job.status}">${job.status}</span></td>
                <td class="text-truncate" style="max-width: 200px;"
                    title="${job.output_name || job.input_file || '-'}">
                    ${job.output_name || job.input_file || '-'}
                </td>
                <td style="width: 120px;">
                    ${['running', 'assigned'].includes(job.status) ? `
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress flex-grow-1" style="height: 6px;">
                                <div class="progress-bar" style="width: ${job.progress}%"></div>
                            </div>
                            <small>${job.progress.toFixed(0)}%</small>
                        </div>
                    ` : '-'}
                </td>
                <td>
                    ${job.assigned_agent_id ?
                        `<code>${job.assigned_agent_id.substring(0, 8)}</code>` : '-'}
                </td>
                <td><small>${formatTimeAgo(job.created_at)}</small></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light" onclick="showJobDetail('${job.job_id}')"
                                title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        ${['pending', 'queued', 'assigned'].includes(job.status) ? `
                            <button class="btn btn-outline-danger" onclick="cancelJob('${job.job_id}')"
                                    title="Cancel">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function updateStats(jobs) {
        const counts = {
            running: 0, assigned: 0, pending: 0, queued: 0,
            completed: 0, failed: 0, cancelled: 0
        };

        jobs.forEach(j => {
            if (counts[j.status] !== undefined) {
                counts[j.status]++;
            }
        });

        document.getElementById('stat-running').textContent = counts.running + counts.assigned;
        document.getElementById('stat-pending').textContent = counts.pending + counts.queued;
        document.getElementById('stat-completed').textContent = counts.completed;
        document.getElementById('stat-failed').textContent = counts.failed;
        document.getElementById('stat-total').textContent = jobs.length;
    }

    async function showJobDetail(jobId) {
        const modal = new bootstrap.Modal(document.getElementById('jobDetailModal'));
        const body = document.getElementById('job-detail-body');
        body.innerHTML = '<div class="text-center py-4">Loading...</div>';
        modal.show();

        try {
            const response = await fetch(`/api/jobs/${jobId}`);
            const job = await response.json();

            body.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="text-muted small">Job ID</label>
                        <div><code>${job.job_id}</code></div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">Type</label>
                        <div><span class="badge bg-secondary">${job.job_type}</span></div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">Status</label>
                        <div><span class="badge-status status-${job.status}">${job.status}</span></div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">Priority</label>
                        <div>${job.priority}</div>
                    </div>
                    <div class="col-12">
                        <label class="text-muted small">Output Name</label>
                        <div>${job.output_name || '-'}</div>
                    </div>
                    ${job.input_file ? `
                        <div class="col-12">
                            <label class="text-muted small">Input File</label>
                            <div class="text-break">${job.input_file}</div>
                        </div>
                    ` : ''}
                    ${job.output_file ? `
                        <div class="col-12">
                            <label class="text-muted small">Output File</label>
                            <div class="text-break">${job.output_file}</div>
                        </div>
                    ` : ''}
                    ${job.preset ? `
                        <div class="col-md-6">
                            <label class="text-muted small">Preset</label>
                            <div>${job.preset}</div>
                        </div>
                    ` : ''}
                    <div class="col-md-6">
                        <label class="text-muted small">Assigned Worker</label>
                        <div>${job.assigned_agent_id || 'Not assigned'}</div>
                    </div>
                    ${['running', 'assigned'].includes(job.status) ? `
                        <div class="col-12">
                            <label class="text-muted small">Progress</label>
                            <div class="progress mt-1" style="height: 10px;">
                                <div class="progress-bar" style="width: ${job.progress}%"></div>
                            </div>
                            <small class="text-muted">${job.progress.toFixed(1)}%</small>
                        </div>
                    ` : ''}
                    ${job.error ? `
                        <div class="col-12">
                            <label class="text-muted small">Error</label>
                            <div class="alert alert-danger mb-0">${job.error}</div>
                        </div>
                    ` : ''}
                    <div class="col-md-6">
                        <label class="text-muted small">Created</label>
                        <div>${formatTimeAgo(job.created_at)}</div>
                    </div>
                    ${job.started_at ? `
                        <div class="col-md-6">
                            <label class="text-muted small">Started</label>
                            <div>${formatTimeAgo(job.started_at)}</div>
                        </div>
                    ` : ''}
                    ${job.completed_at ? `
                        <div class="col-md-6">
                            <label class="text-muted small">Completed</label>
                            <div>${formatTimeAgo(job.completed_at)}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        } catch (error) {
            body.innerHTML = '<div class="alert alert-danger">Failed to load job details</div>';
        }
    }

    async function cancelJob(jobId) {
        if (!confirm('Cancel this job?')) return;
        try {
            const response = await fetch(`/api/jobs/${jobId}/cancel`, { method: 'POST' });
            if (response.ok) {
                refreshJobs();
            }
        } catch (error) {
            console.error('Failed to cancel job:', error);
        }
    }

    async function refreshJobs() {
        try {
            const response = await fetch('/api/jobs');
            allJobs = await response.json();

            updateConnectionStatus(true);
            updateStats(allJobs);
            renderActiveJobs(allJobs);
            renderJobsTable(allJobs);

            // Also load approval data
            await loadApprovalData();
        } catch (error) {
            console.error('Failed to refresh jobs:', error);
            updateConnectionStatus(false);
        }
    }

    async function loadApprovalData() {
        try {
            const [jobsRes, workersRes, presetsRes, uploadErrorsRes] = await Promise.all([
                fetch('/api/jobs/awaiting-approval'),
                fetch('/api/workers'),
                fetch('/api/jobs/presets'),
                fetch('/api/jobs/upload-errors')
            ]);

            pendingApprovalJobs = await jobsRes.json();
            const workersData = await workersRes.json();
            availableWorkers = (workersData || []).filter(w => w.status !== 'offline');
            const presetsData = await presetsRes.json();
            availablePresets = presetsData.presets || [];
            uploadErrorJobs = await uploadErrorsRes.json();

            renderApprovalSection();
            renderUploadErrorsSection();
        } catch (error) {
            console.error('Failed to load approval data:', error);
        }
    }

    function renderUploadErrorsSection() {
        const section = document.getElementById('upload-errors-section');
        const container = document.getElementById('upload-errors-container');
        const countBadge = document.getElementById('upload-errors-count');

        countBadge.textContent = uploadErrorJobs.length;

        if (uploadErrorJobs.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';

        container.innerHTML = `<div class="row g-3">${uploadErrorJobs.map(job => `
            <div class="col-md-6 col-xl-4">
                <div class="job-card" style="border-left: 3px solid var(--bs-danger);">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="badge bg-danger">upload failed</span>
                            <span class="badge bg-secondary ms-1">transcode</span>
                        </div>
                    </div>
                    <div class="fw-medium mb-2 text-truncate" title="${job.output_name || 'Unknown'}">
                        ${job.output_name || 'Unknown'}
                    </div>
                    <div class="small text-muted mb-2">
                        <i class="bi bi-file-earmark me-1"></i>
                        ${job.output_file || 'File location unknown'}
                    </div>
                    <div class="small text-danger mb-3">
                        <i class="bi bi-exclamation-circle me-1"></i>
                        ${job.error || 'Upload failed'}
                    </div>
                    <div class="small text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        File is available locally. Restart agent to retry upload.
                    </div>
                </div>
            </div>
        `).join('')}</div>`;
    }

    function renderApprovalSection() {
        const section = document.getElementById('approval-section');
        const container = document.getElementById('approval-jobs-container');
        const countBadge = document.getElementById('approval-count');

        countBadge.textContent = pendingApprovalJobs.length;

        if (pendingApprovalJobs.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';

        container.innerHTML = `<div class="row g-3">${pendingApprovalJobs.map(job => `
            <div class="col-md-6 col-xl-4">
                <div class="job-card" style="border-left: 3px solid var(--bs-warning);">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="badge bg-warning text-dark">awaiting approval</span>
                            <span class="badge bg-secondary ms-1">transcode</span>
                        </div>
                    </div>
                    <div class="fw-medium mb-2 text-truncate" title="${job.output_name || 'Unknown'}">
                        ${job.output_name || job.source_disc_name || 'Unknown'}
                    </div>
                    ${job.source_disc_name ? `
                        <div class="small text-muted mb-2">
                            <i class="bi bi-disc me-1"></i>Source: ${job.source_disc_name}
                        </div>
                    ` : ''}
                    <div class="small text-muted mb-3">
                        <i class="bi bi-file-earmark me-1"></i>
                        ${job.input_file_size ? formatSize(job.input_file_size) : 'Unknown size'}
                    </div>
                    <button class="btn btn-primary btn-sm w-100" onclick="showApprovalModal('${job.job_id}')">
                        <i class="bi bi-gear me-1"></i>Configure & Start
                    </button>
                </div>
            </div>
        `).join('')}</div>`;
    }

    function showApprovalModal(jobId) {
        const job = pendingApprovalJobs.find(j => j.job_id === jobId);
        if (!job) return;

        currentApprovalJobId = jobId;

        const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
        const body = document.getElementById('approval-modal-body');

        // Separate GPU and CPU workers
        const gpuWorkers = availableWorkers.filter(w => w.capabilities?.nvenc || w.capabilities?.qsv);
        const cpuWorkers = availableWorkers.filter(w => !w.capabilities?.nvenc && !w.capabilities?.qsv);

        // Check if any worker has VLC installed
        const vlcWorker = availableWorkers.find(w => w.capabilities?.vlc_installed && w.agent_id);
        const hasVlc = !!vlcWorker;

        // Build VLC preview button
        let vlcButtonHtml = '';
        if (hasVlc) {
            vlcButtonHtml = `
                <button class="btn btn-outline-info btn-sm" onclick="launchVlcPreview('${job.input_file}', '${vlcWorker.agent_id}')" id="vlc-preview-btn">
                    <i class="bi bi-play-circle me-1"></i>Preview with VLC
                </button>
            `;
        } else {
            vlcButtonHtml = `
                <button class="btn btn-outline-secondary btn-sm" disabled title="VLC is not installed on the agent">
                    <i class="bi bi-play-circle me-1"></i>Preview with VLC
                </button>
                <a href="https://www.videolan.org/vlc/" target="_blank" class="btn btn-outline-secondary btn-sm ms-1" title="Download VLC">
                    <i class="bi bi-download me-1"></i>Get VLC
                </a>
            `;
        }

        // Build thumbnail preview section (Stage 2)
        let thumbnailHtml = '';
        if (job.thumbnails && job.thumbnails.length > 0) {
            thumbnailHtml = `
                <div class="thumbnail-preview-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="bi bi-images me-2"></i>Video Preview</h6>
                        <div>${vlcButtonHtml}</div>
                    </div>
                    <div class="thumbnail-grid">
                        ${job.thumbnails.map((url, i) => `
                            <div class="thumbnail-item">
                                <img src="${url}" alt="Preview ${i+1}" onclick="showFullThumbnail('${url}')">
                                <span class="thumbnail-timestamp">${formatTimestamp(job.thumbnail_timestamps ? job.thumbnail_timestamps[i] : 0)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="small text-muted mt-2 text-center">
                        <i class="bi bi-info-circle me-1"></i>Verify this is the correct content before transcoding
                    </div>
                </div>
            `;
        } else {
            thumbnailHtml = `
                <div class="thumbnail-preview-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="bi bi-images me-2"></i>Video Preview</h6>
                        <div>${vlcButtonHtml}</div>
                    </div>
                    <div class="no-thumbnails">
                        <i class="bi bi-camera-video-off me-2"></i>No preview thumbnails available
                    </div>
                </div>
            `;
        }

        body.innerHTML = `
            ${thumbnailHtml}

            <!-- File Naming Section (TA9 & TA10) -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header border-secondary">
                    <h6 class="mb-0"><i class="bi bi-pencil me-2"></i>Output Filename</h6>
                </div>
                <div class="card-body">
                    ${renderFilenameEditor(job)}
                </div>
            </div>

            <div class="row g-3 mb-4">
                ${job.source_disc_name ? `
                    <div class="col-md-6">
                        <label class="text-muted small">Source Disc</label>
                        <div>${job.source_disc_name}</div>
                    </div>
                ` : ''}
                <div class="col-md-6">
                    <label class="text-muted small">Input File Size</label>
                    <div>${job.input_file_size ? formatSize(job.input_file_size) : 'Unknown'}</div>
                </div>
            </div>

            <h6 class="mb-3"><i class="bi bi-gpu-card me-2"></i>Select Worker</h6>
            <div class="mb-4">
                ${gpuWorkers.length > 0 ? `
                    <div class="mb-2 text-success small fw-medium">GPU Workers (Recommended)</div>
                    ${gpuWorkers.map((w, i) => `
                        <div class="form-check mb-2 p-3 border border-secondary rounded ${i === 0 ? 'border-success' : ''}">
                            <input class="form-check-input" type="radio" name="worker"
                                   id="worker-${w.worker_id}" value="${w.worker_id}"
                                   ${i === 0 ? 'checked' : ''}>
                            <label class="form-check-label d-flex justify-content-between w-100" for="worker-${w.worker_id}">
                                <span>
                                    <strong>${w.worker_id}</strong>
                                    <span class="badge bg-success ms-2">
                                        ${w.capabilities?.nvenc ? 'NVENC' : ''}${w.capabilities?.qsv ? 'QuickSync' : ''}
                                    </span>
                                    ${w.capabilities?.hevc ? '<span class="badge bg-info ms-1">HEVC</span>' : ''}
                                    ${w.capabilities?.av1 ? '<span class="badge bg-info ms-1">AV1</span>' : ''}
                                </span>
                                <span class="badge bg-${w.status === 'available' ? 'success' : 'warning'}">${w.status}</span>
                            </label>
                        </div>
                    `).join('')}
                ` : ''}

                ${cpuWorkers.length > 0 ? `
                    <div class="mb-2 mt-3 text-muted small fw-medium">CPU Workers (Slower)</div>
                    ${cpuWorkers.map((w, i) => `
                        <div class="form-check mb-2 p-3 border border-secondary rounded">
                            <input class="form-check-input" type="radio" name="worker"
                                   id="worker-${w.worker_id}" value="${w.worker_id}"
                                   ${gpuWorkers.length === 0 && i === 0 ? 'checked' : ''}>
                            <label class="form-check-label d-flex justify-content-between w-100" for="worker-${w.worker_id}">
                                <span>
                                    <strong>${w.worker_id}</strong>
                                    <span class="badge bg-secondary ms-2">${w.capabilities?.cpu_threads || '?'} threads</span>
                                </span>
                                <span class="badge bg-${w.status === 'available' ? 'success' : 'warning'}">${w.status}</span>
                            </label>
                        </div>
                    `).join('')}
                ` : ''}

                ${availableWorkers.length === 0 ? `
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No workers available. Please ensure at least one worker is online.
                    </div>
                ` : ''}
            </div>

            <h6 class="mb-3"><i class="bi bi-sliders me-2"></i>Select Preset</h6>
            <div class="mb-3">
                <select class="form-select" id="preset-select" onchange="updatePresetInfo()">
                    <option value="">Select a preset...</option>
                    ${availablePresets.map((p, i) => `
                        <option value="${p.id}" data-requires="${p.requires || ''}" ${i === 0 ? 'selected' : ''}>${p.name}</option>
                    `).join('')}
                </select>
                <div id="preset-warning" class="text-warning small mt-2" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    <span id="preset-warning-text"></span>
                </div>
            </div>
        `;

        // Enable/disable approve button
        document.getElementById('approve-btn').disabled = availableWorkers.length === 0;

        // Check preset compatibility
        setTimeout(updatePresetInfo, 100);

        modal.show();
    }

    function updatePresetInfo() {
        const select = document.getElementById('preset-select');
        if (!select) return;

        const option = select.options[select.selectedIndex];
        if (!option) return;

        const requires = option.dataset.requires;
        const warning = document.getElementById('preset-warning');
        const warningText = document.getElementById('preset-warning-text');

        if (!requires || !warning) {
            if (warning) warning.style.display = 'none';
            return;
        }

        const selectedWorker = document.querySelector('input[name="worker"]:checked');
        if (!selectedWorker) {
            warning.style.display = 'none';
            return;
        }

        const worker = availableWorkers.find(w => w.worker_id === selectedWorker.value);
        if (!worker) return;

        let hasCapability = false;
        if (requires === 'nvenc') hasCapability = worker.capabilities?.nvenc;
        if (requires === 'qsv') hasCapability = worker.capabilities?.qsv;

        if (!hasCapability) {
            warning.style.display = 'block';
            warningText.textContent = `Selected worker does not support ${requires.toUpperCase()}. Choose a different worker or preset.`;
        } else {
            warning.style.display = 'none';
        }
    }

    async function submitApproval() {
        if (!currentApprovalJobId) return;

        const selectedWorker = document.querySelector('input[name="worker"]:checked');
        const presetSelect = document.getElementById('preset-select');
        const outputNameInput = document.getElementById('output-name-input');

        if (!selectedWorker) {
            alert('Please select a worker');
            return;
        }

        if (!presetSelect.value) {
            alert('Please select a preset');
            return;
        }

        // Get the (possibly edited) output name
        const outputName = outputNameInput?.value?.trim() || null;

        const approveBtn = document.getElementById('approve-btn');
        approveBtn.disabled = true;
        approveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Starting...';

        try {
            const requestBody = {
                worker_id: selectedWorker.value,
                preset: presetSelect.value
            };

            // Include output_name if it was edited (TA9/TA10)
            if (outputName) {
                requestBody.output_name = outputName;
            }

            const response = await fetch(`/api/jobs/${currentApprovalJobId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('approvalModal')).hide();
                currentApprovalJobId = null;
                refreshJobs();
            } else {
                const error = await response.json();
                alert(`Failed to approve job: ${error.detail || error.error || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Failed to approve job:', error);
            alert('Failed to approve job');
        } finally {
            approveBtn.disabled = false;
            approveBtn.innerHTML = '<i class="bi bi-play-fill me-1"></i>Start Transcoding';
        }
    }

    // Filter change handler
    document.getElementById('status-filter').addEventListener('change', () => {
        renderJobsTable(allJobs);
    });

    // Format timestamp in MM:SS format
    function formatTimestamp(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Parse TV show filename pattern: "Show Name - S01E02 - Episode Title" or "Show Name - S01E02"
    function parseTVFilename(filename) {
        const pattern = /^(.+?) - S(\d+)E(\d+)(?: - (.+))?$/;
        const match = filename.match(pattern);
        if (match) {
            return {
                isTVShow: true,
                showName: match[1],
                season: parseInt(match[2]),
                episode: parseInt(match[3]),
                episodeTitle: match[4] || ''
            };
        }
        return { isTVShow: false };
    }

    // Build filename from TV show components
    function buildTVFilename(showName, season, episode, episodeTitle) {
        const epCode = `S${String(season).padStart(2, '0')}E${String(episode).padStart(2, '0')}`;
        if (episodeTitle) {
            return `${showName} - ${epCode} - ${episodeTitle}`;
        }
        return `${showName} - ${epCode}`;
    }

    // Render filename editor (TA9 & TA10)
    function renderFilenameEditor(job) {
        const outputName = job.output_name || 'Unknown';
        const parsed = parseTVFilename(outputName);

        if (parsed.isTVShow) {
            // TV Show: Show structured editor with episode adjustment
            return `
                <div class="mb-3">
                    <div class="small text-info mb-2">
                        <i class="bi bi-tv me-1"></i>TV Show Detected - Adjust episode details if needed
                    </div>
                    <div class="row g-2">
                        <div class="col-12">
                            <label class="form-label small text-muted">Show Name</label>
                            <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary"
                                   id="tv-show-name" value="${escapeHtml(parsed.showName)}" onchange="updateTVFilename()">
                        </div>
                        <div class="col-4">
                            <label class="form-label small text-muted">Season</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary"
                                   id="tv-season" value="${parsed.season}" min="1" max="99" onchange="updateTVFilename()">
                        </div>
                        <div class="col-4">
                            <label class="form-label small text-muted">Episode</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary"
                                   id="tv-episode" value="${parsed.episode}" min="1" max="999" onchange="updateTVFilename()">
                        </div>
                        <div class="col-4">
                            <label class="form-label small text-muted">&nbsp;</label>
                            <div class="btn-group w-100">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="adjustEpisode(-1)" title="Previous Episode">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="adjustEpisode(1)" title="Next Episode">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Episode Title (optional)</label>
                            <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary"
                                   id="tv-episode-title" value="${escapeHtml(parsed.episodeTitle)}"
                                   placeholder="Leave blank if unknown" onchange="updateTVFilename()">
                        </div>
                    </div>
                    <div class="mt-3 p-2 bg-secondary bg-opacity-25 rounded">
                        <label class="form-label small text-muted mb-1">Final Filename</label>
                        <div class="fw-medium text-light" id="final-filename-preview">${escapeHtml(outputName)}</div>
                    </div>
                    <input type="hidden" id="output-name-input" value="${escapeHtml(outputName)}">
                </div>
            `;
        } else {
            // Movie or unknown: Simple text input
            return `
                <div class="mb-3">
                    <label class="form-label small text-muted">Filename (without extension)</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary"
                           id="output-name-input" value="${escapeHtml(outputName)}">
                    <div class="form-text">Edit the filename if the detected title is incorrect</div>
                </div>
            `;
        }
    }

    // Update TV filename when components change
    function updateTVFilename() {
        const showName = document.getElementById('tv-show-name')?.value || '';
        const season = parseInt(document.getElementById('tv-season')?.value) || 1;
        const episode = parseInt(document.getElementById('tv-episode')?.value) || 1;
        const episodeTitle = document.getElementById('tv-episode-title')?.value || '';

        const filename = buildTVFilename(showName, season, episode, episodeTitle);

        const preview = document.getElementById('final-filename-preview');
        const input = document.getElementById('output-name-input');

        if (preview) preview.textContent = filename;
        if (input) input.value = filename;
    }

    // Adjust episode number up or down
    function adjustEpisode(delta) {
        const episodeInput = document.getElementById('tv-episode');
        if (episodeInput) {
            let value = parseInt(episodeInput.value) || 1;
            value = Math.max(1, Math.min(999, value + delta));
            episodeInput.value = value;
            updateTVFilename();
        }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    // Show fullsize thumbnail in modal
    function showFullThumbnail(url) {
        let modal = document.getElementById('thumbnail-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'thumbnail-modal';
            modal.className = 'thumbnail-modal';
            modal.onclick = () => modal.classList.remove('active');
            modal.innerHTML = '<img src="" alt="Full size preview">';
            document.body.appendChild(modal);
        }
        modal.querySelector('img').src = url;
        modal.classList.add('active');
    }

    // Launch VLC preview on agent
    async function launchVlcPreview(filePath, agentId) {
        const btn = document.getElementById('vlc-preview-btn');
        if (!btn) return;

        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Launching...';

        try {
            const response = await fetch('/api/vlc/preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    agent_id: agentId,
                    file_path: filePath,
                    fullscreen: true
                })
            });

            const data = await response.json();

            if (response.ok && data.command_id) {
                // Show success state briefly
                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>VLC Launched';
                btn.classList.remove('btn-outline-info');
                btn.classList.add('btn-success');

                // Poll for completion (optional, just for feedback)
                setTimeout(async () => {
                    try {
                        const statusRes = await fetch(`/api/vlc/commands/${data.command_id}/status`);
                        const status = await statusRes.json();
                        if (status.status === 'failed') {
                            btn.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>Launch Failed';
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-danger');
                        }
                    } catch (e) {
                        console.error('Failed to check VLC status:', e);
                    }
                }, 3000);

                // Reset button after delay
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('btn-success', 'btn-danger');
                    btn.classList.add('btn-outline-info');
                }, 5000);
            } else {
                throw new Error(data.detail || data.error || 'Failed to launch VLC');
            }
        } catch (error) {
            console.error('VLC preview failed:', error);
            btn.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>Error';
            btn.classList.remove('btn-outline-info');
            btn.classList.add('btn-danger');

            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-outline-info');
            }, 3000);
        }
    }

    // Initial load
    refreshJobs();

    // Auto-refresh
    refreshInterval = setInterval(refreshJobs, 3000);

    window.addEventListener('beforeunload', () => {
        if (refreshInterval) clearInterval(refreshInterval);
    });
</script>
{% endblock %}
