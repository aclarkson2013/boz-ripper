# Boz Ripper Docker Compose
# Run with: docker-compose up -d

services:
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: boz-ripper-server
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - BOZ_DEBUG=false
      - BOZ_API_KEY=${BOZ_API_KEY:-}
      # TheTVDB settings (for TV show metadata)
      - BOZ_THETVDB_API_KEY=${BOZ_THETVDB_API_KEY:-}
      # OMDb settings (for movie metadata)
      - BOZ_OMDB_API_KEY=${BOZ_OMDB_API_KEY:-}
      # Extras filtering settings
      - BOZ_EXTRAS_MIN_DURATION_SECONDS=${BOZ_EXTRAS_MIN_DURATION_SECONDS:-600}
      - BOZ_EXTRAS_DURATION_VARIANCE=${BOZ_EXTRAS_DURATION_VARIANCE:-0.4}
      # NAS settings (optional)
      - BOZ_NAS_ENABLED=${BOZ_NAS_ENABLED:-false}
      - BOZ_NAS_HOST=${BOZ_NAS_HOST:-}
      - BOZ_NAS_MOVIE_PATH=${BOZ_NAS_MOVIE_PATH:-Movies}
      - BOZ_NAS_TV_PATH=${BOZ_NAS_TV_PATH:-TV Shows}
    volumes:
      # Temp storage for ripped files
      - boz-temp:/data/temp
      # Output storage for transcoded files
      - boz-output:/data/output
      # Optional: Mount NAS share
      - /mnt/qnap-plex:/nas:rw
    networks:
      - boz-network
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: boz-ripper-dashboard
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - BOZ_API_URL=http://server:8000
      - FLASK_DEBUG=false
    depends_on:
      - server
    networks:
      - boz-network
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:5000/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

volumes:
  boz-temp:
    driver: local
  boz-output:
    driver: local

networks:
  boz-network:
    driver: bridge
